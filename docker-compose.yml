services:
  ntp:
    build: ./ntp
    container_name: ntp_server
    cap_add:
      - SYS_TIME  # TODO: Droit pour l'heure syst√®me ?
    ports: 
      - "20123:123/udp"
    networks:
      lab_net:
        ipv4_address: 172.28.0.4

  dns:
    build: ./dns
    container_name: dns_server
    ports: 
      - "20053:53/udp" 
      - "20053:53/tcp" # TODO: Ports DNS ?
    networks:
      lab_net:
        ipv4_address: 172.28.0.5
  
  vpn:
    build: ./vpn
    container_name: vpn_server
    cap_add: 
      - NET_ADMIN # TODO: Droit pour l'interface TUN ?
    sysctls:
      - net.ipv4.ip_forward=1  # Activer le routage IP
    devices:
      - "/dev/net/tun:/dev/net/tun"
    ports: 
      - "21194:1194/udp" 
    networks:
      lab_net:
        ipv4_address: 172.28.0.2

  postgres:
    build: ./postgres
    container_name: postgres_db
    environment:
      POSTGRES_PASSWORD: "postgres" # A definir
    volumes: 
      - "pg-data:/var/lib/postgresql/data"
      - "./radius/init_db.sql:/docker-entrypoint-initdb.d/init.sql"
    networks:
      lab_net:
        ipv4_address: 172.28.0.10
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5


  radius:
    build: ./radius
    container_name: radius_server
    ports: 
      - "21812:1812/udp"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DB_HOST: postgres_db # TODO: Nom du service DB ?
    networks:
      lab_net:
        ipv4_address: 172.28.0.3

networks:
  lab_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
volumes: 
  pg-data: